<html lang="en">
<head>
<script src="jquery-1.5.1.min.js"></script>
<script id="bldg-vertex" type="x-shader/x-vertex">
attribute vec3 pos;
attribute vec3 norm;
uniform vec3 u_resolution;
uniform vec3 u_centerdeg;
uniform vec3 u_lightdir;
varying float light;
void main() {
  vec3 proj = (pos-u_centerdeg)/u_resolution;
  proj *= vec3(1.0+proj[2],1.0+proj[2],-1.0);
  gl_Position = vec4(proj,1.0);
  light = dot(norm,u_lightdir)*0.5+0.5;
}
</script>
<script id="bldg-fragment" type="x-shader/x-fragment">
precision mediump float;
varying float light;
void main() {
  gl_FragColor = vec4(1.0, light, 1.0, 1.0);
}
</script>
</head>
<body>
  <canvas id="c" width="800" height="600" style="border: 1px solid grey"></canvas>
<script>
  function draw(d) {
    var i, j;
    c.beginPath();
    c.moveTo( (d[0][0]-12.48)*300000, (d[0][1]-41.897)*300000+200 );
    for( i=1; i<d.length; ++i ) {
      c.lineTo( (d[i][0]-12.48)*300000, (d[i][1]-41.897)*300000+200 );
    }
    c.stroke();
  }

  //vNormal = normal;
  //gl_Position = projectionMatrix * modelViewMatrix * vec4(a_position,1.0);
  var bldgs = [ { p:[ [0,0],[25,0],[25,25],[0,25] ], h:4 }, { p:[ [0,0],[0,25],[25,25],[25,0] ], h:4 } ]
    , canvas = $('#c')[0]
    , c = canvas.getContext('2d')
    , i, j, k
    ;

  var d = [[[12.480341044,41.897735929],[12.480655545,41.897823455],[12.480986484,41.897918938],[12.480928992,41.898142734],[12.481065446,41.898173492],[12.481129855,41.898009874],[12.481164171,41.897924488],[12.481437438,41.897983931],[12.481429533,41.898006464],[12.481546943,41.898032073],[12.481808173,41.897363556],[12.481515053,41.897302642],[12.481747716,41.896670091],[12.481725528,41.896665678],[12.480821284,41.896486343],[12.480633536,41.896979079],[12.480543615,41.897214981],[12.48053023,41.897250086],[12.480341044,41.897735929]],[[12.480942556,41.89711709],[12.481018284,41.896918365],[12.481093473,41.896934145],[12.481042269,41.897068545],[12.481419113,41.897148049],[12.48137231,41.897270948],[12.481169022,41.897228154],[12.48119139,41.897169579],[12.480942556,41.89711709]],[[12.480589878,41.897573446],[12.480673152,41.897297159],[12.48132964,41.897415578],[12.481235317,41.897627474],[12.481200822,41.89770497],[12.48079685,41.897617979],[12.480738998,41.897605542],[12.480589878,41.897573446]],[[12.480755976,41.897123041],[12.480831255,41.896913952],[12.48077008,41.896901782],[12.480779782,41.896874768],[12.480889376,41.896896634],[12.480804216,41.89713267],[12.480755976,41.897123041]],[[12.48154829,41.89748037],[12.481570658,41.897435169],[12.481626174,41.897450348],[12.481603627,41.897495548],[12.48154829,41.89748037]],[[12.48121277,41.89786237],[12.481305655,41.897645861],[12.481556375,41.897705438],[12.481463489,41.897921947],[12.48121277,41.89786237]],[[12.481211871,41.897033842],[12.481316256,41.896723785],[12.481529426,41.896763437],[12.481425131,41.897073694],[12.481211871,41.897033842]],[[12.480981453,41.897845988],[12.481013793,41.897775446],[12.481075687,41.897791159],[12.481043437,41.897861635],[12.480981453,41.897845988]],[[12.480896742,41.896823683],[12.480942467,41.896693294],[12.481138659,41.896727931],[12.48109015,41.896858988],[12.480896742,41.896823683]],[[12.480744298,41.897171251],[12.480758312,41.897138487],[12.480857396,41.897162157],[12.480843293,41.897194988],[12.480744298,41.897171251]],[[12.480669648,41.897008768],[12.48068456,41.896970587],[12.480708366,41.896975736],[12.480693543,41.897013849],[12.480669648,41.897008768]],[[12.480655185,41.897222136],[12.480670187,41.89717747],[12.480726422,41.897187968],[12.48071142,41.897232634],[12.480655185,41.897222136]]];

  // enforce winding order
  for( j=0; j<d.length; ++j ) {
    var bldg = d[j];
    l = bldg.length;
    var area = 0;
    for( i=0; i<l; i++ ) {
      area += (bldg[i][0] * bldg[(i+1)%l][1]) - (bldg[(i+1)%l][0] * bldg[i][1]);
    }

    // set consistent winding order (opposite for outer and holes)
    if( j==0 ) {
      if( area>0 ) {
        bldg.reverse();
        console.log('reversed',j);
      }
      c.strokeStyle = 'rgb(0,0,255)';
    } else { 
      if( area<0 ) {
        bldg.reverse();
        console.log('reversed',j);
      }
      c.strokeStyle = 'rgb(255,0,0)';
    }
    
    draw(bldg);
    console.log(area);
  }



</script>
</body>
