<html>
<head>
 <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
</head>
<body>
<canvas id="globe" width=50 height=50></canvas>
<canvas id="map"></canvas>
<script>
var sx0 = [], sx = [], sy = []
  , canvas = $('#globe')
  , w = canvas.width(), h = canvas.height()
  , c = canvas[0].getContext('2d')
  , d = c.getImageData(0, 0, w, h)
  , cm = ($('#map').attr( { width: 6*128, height: 3*128 } ))[0].getContext('2d')
  , dm= cm.createImageData(6*128, 3*128), loadcount = 0
  , i, j, k, l, m, n
  ;

// load map tiles
for( i=0; i<6; ++i ) {
  for( j=0; j<3; ++j ) {
    (function(x,y){
      var img = new Image;
      $(img).load(function(){
        cm.drawImage(img,x*128,y*128);
        loadcount++;
        if( loadcount = 3*6 ) {
          dm = cm.getImageData(0, 0, 6*128, 3*128);
        }
      }).attr('src','tiles/mapnik/0/tile_'+y+'_'+x+'.png');
    })(i,j);
  }
}

/* forward transform (assum lat lon in rad)
 x = sin(lat)*cos(lon)*w/2;
 y = sin(lon)*h/2

 lon = asin(2y/h)
 x/y = sin(lat)/tan(lon) * w/h
 lat = asin( (x*h)/(y*w) * tan(lon) )

*/

var a,b,lon,lat;
for( i = 0; i<h; ++i ) {
  sx0[i] = 0; sx[i] = []; sy[i] = []; 
  for( j = 0; j<w; ++j ) {
    a = 2*(i-h/2)/h;
    if( Math.abs(a) > 1.0 ) { sx0[i]++; continue; }
    lon = Math.asin(a);
    b = ((j-w/2)*h)/((i-h/2)*w)*Math.tan(lon);
    if( Math.abs(b) > 1.0 ) { sx0[i]++; continue; }
    lat = Math.asin(b);
    sx[i].push(Math.floor(lon/Math.PI*3*128));
    sy[i].push(Math.floor(1.5*(128-lat/Math.PI*128)));
  }
}

// draw the globe
function draw() {
  for( i = 0; i<h; ++i ) {
    l = sx[i].length; 
    m = sx0[i]*4+i*w*4;
    for( j = 0; j<l; ++j ) {
      n = sx[i][j]*4 + sy[i][j]*4*128*6;
      for( k=0; k<4; ++k ) {
        d[m+k] = dm[n+k];
      }
    }
  }
  c.putImageData(d,0,0);
}

setInterval(draw,20);

</script>
</body>
</html>
