<html>
<head>
  <title>Client-side tile rendering test</title>
  <script type="text/javascript" src="jquery-1.5.1.min.js"></script>
  <style>
    canvas {
      border: 1px solid black; 
    }
  </style>
</head>
<body>
  <h1>Client-side tile rendering test</h1>
  <img src="http://6.www.toolserver.org/~dschwen/wma/tiles/mapnik/12/2898/tile_2898_660.png"/>
  <div style="display: inline-block; position: relative">
    <canvas width="128" height="128" id="tile"></canvas>
    <div id="hilight" style="background-color: red; display: none; position: absolute; width: 64px; height: 64px; pointer-events: none"></div>
  </div>
  <p>Bounding box: <span id="bbox"></span></p>
  <script>
    var canvas,c,w,h
      , bx1, by1, bx2, by2, bw, bh, d=[]
      , x=660, y=2898, z=12
      //, x=660*2+1, y=2898*2, z=13
      ;

    // top right: lindau
    //http://6.www.toolserver.org/~dschwen/wma/tiles/mapnik/12/2898/tile_2898_660.png

    // draw the data
    function drawGeoJSON() {
      var i, j, k, g;
      c.lineWidth = 1.0;
      c.strokeStyle = "rgb(0,0,255)";
      c.clearRect(0,0,128,128);
      c.beginPath();
      
      for(i =0; i<d.length; ++i ) {
        g = d[i].geo.coordinates[0];
        if( g.length > 0 ) {
          c.moveTo((g[0][0]-bx1)*128/bw,128-(g[0][1]-by1)*128/bh);
          for( j=1; j<g.length; ++j ) {
            c.lineTo((g[j][0]-bx1)*128/bw,128-(g[j][1]-by1)*128/bh);
            //c.lineTo(g[j][0],g[j][1]);
          }
        }
      }
      c.stroke();
    }

    // return path element at screen coordinates
    function pathAt(x,y) {
    }

    function gotData(data) {
      d = data;
      update();
    }

    function update() {
      bx1 = x*60.0/(1<<z);
      by1 = 90.0 - ( ((y+1.0)*60.0) / (1<<z) );
      bx2 = (x+1) * 60.0 / (1<<z);
      by2 = 90.0 - ( (y*60.0) / (1<<z) );
      bw = bx2-bx1;
      bh = by2-by1;

      $('#bbox').text(bx1+' '+by1+', '+bx2+' '+by2);
      drawGeoJSON();
    }

    $(function(){
      canvas = $('#tile');
      w = canvas[0].width;
      h = canvas[0].height;
      c = canvas[0].getContext('2d');

      $.ajax({
        url: 'jsontile.php?x='+x+'&y='+y+'&z='+z,
        dataType: 'json',
        success: gotData
      });

      canvas
        .click(function(e){
          z++;
          x = x*2 + Math.floor(e.offsetX/64);
          y = y*2 + Math.floor(e.offsetY/64);
          update();
        })
        .mousemove(function(e){
          var x = Math.floor(e.offsetX/64)
            , y =  Math.floor(e.offsetY/64);
          $('#hilight').fadeTo(200,0.5).css({
            top: (y>0?64:0) + 'px',
            left: (x>0?64:0) + 'px'
          });
        })
        .mouseleave( function(e) {
          $('#hilight').fadeOut(200);
        });

    });
  </script>
</body>
</html>
